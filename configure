#!/bin/bash
base=$(dirname $(readlink -f "$0"))
required=("git" "make" "wget" "cmake" "g++" "pkg-config" "doxygen")
err=0
for cmd in "${required[@]}"; do
	if ! command -v "$cmd" &> /dev/null; then
		echo "'$cmd' faltando. Favor instalar."
		err=1
	fi
done
if [ "$err" -eq 1 ]; then exit 1; fi

echo "Baixando dependencias"
read -p "Continuar? [S/n] " yn
if [[ $yn != [SsYy]* ]]; then
	exit 1
fi

temp=$(mktemp -d)
deps=$(mktemp -d -p $temp)
mkdir -p $deps/{lib,include}

download() {
	set -e
	git init
	git remote add origin "$1" 2>/dev/null
	git fetch origin
	git reset --hard "origin/$2"

	mkdir -p build && cd build && cmake ..
	make -j8
}
download_box2d() {
	dir=$(mktemp -d -p $temp) && cd $dir
	download "https://github.com/erincatto/box2d" "main"
	cp -r "$dir/include"/* "$deps/include"
	cp -r "$dir/build/bin"/* "$deps/lib"
}
download_sfml() {
	dir=$(mktemp -d -p $temp) && cd $dir
	download "https://github.com/SFML/SFML" "2.5.x"
	cp -r "$dir/include"/* "$deps/include"
	cp -r "$dir/build/lib"/* "$deps/lib"
}
download_candle() {
	dir=$(mktemp -d -p $temp) && cd $dir
	download "https://github.com/MiguelMJ/Candle" "master"
	mv "$dir/include"/* "$deps/include"
	mv "$dir/build/lib"/* "$deps/lib"
}
abort() {
	echo "$@"
	rm -rf "$temp"
}

if ! pkg-config --exists sfml-graphics sfml-window sfml-system; then
	trap "abort Erro ao configurar o SFML. Procure por 'libsfml-dev' no seu gerenciador de pacotes" EXIT
	download_sfml "$sfml_dir"
	export CPLUS_INCLUDE_PATH="$deps/include:$CPLUS_INCLUDE_PATH"&
fi

trap "abort Abortando" EXIT
download_candle&
download_box2d&
wget -O "$deps/include/doctest.h" "https://github.com/doctest/doctest/releases/download/v2.4.11/doctest.h"&
wait

trap - EXIT
rm -rf "$base/deps"
mv "$deps" "$base/deps"
rm -rf "$temp"
